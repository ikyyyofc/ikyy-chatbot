<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ChatGPT-like</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <div class="app">
      <header class="header">
        <div class="title">ChatGPT-like</div>
        <div class="controls">
          <button class="secondary" id="reset">Reset</button>
        </div>
      </header>

      <main id="chat" class="chat"></main>

      <footer class="composer">
        <textarea id="input" placeholder="Ketik pesanâ€¦ (Enter kirim, Shift+Enter baris baru)" rows="1"></textarea>
        <button id="send">Kirim</button>
      </footer>
    </div>

    <script>
      const chat = document.getElementById('chat')
      const input = document.getElementById('input')
      const sendBtn = document.getElementById('send')
      const resetBtn = document.getElementById('reset')
      // fixed default model on server; no model selector

      let loading = false
      let messages = [{ role: 'assistant', content: 'Halo! Aku asisten AI. Ada yang bisa kubantu?' }]

      function render() {
        chat.innerHTML = ''
        for (const m of messages) {
          const row = document.createElement('div')
          row.className = `msg ${m.role}`
          const bubble = document.createElement('div')
          bubble.className = 'bubble'
          bubble.textContent = m.content
          row.appendChild(bubble)
          chat.appendChild(row)
        }
        if (loading) {
          const row = document.createElement('div')
          row.className = 'msg assistant'
          const bubble = document.createElement('div')
          bubble.className = 'bubble typing'
          bubble.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>'
          row.appendChild(bubble)
          chat.appendChild(row)
        }
        chat.scrollTop = chat.scrollHeight
      }

      async function send() {
        const text = input.value.trim()
        if (!text || loading) return
        messages.push({ role: 'user', content: text })
        input.value = ''
        loading = true
        render()
        try {
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages })
          })
          if (!res.ok) throw new Error('API error ' + res.status)
          const data = await res.json()
          const replyText = (data && data.reply && (data.reply.content || data.reply)) || ''
          messages.push({ role: 'assistant', content: replyText })
        } catch (e) {
          console.error(e)
          messages.push({ role: 'assistant', content: 'Maaf, terjadi kesalahan memproses permintaan.' })
        } finally {
          loading = false
          render()
        }
      }

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault()
          send()
        }
      })
      sendBtn.addEventListener('click', send)
      resetBtn.addEventListener('click', () => {
        messages = [{ role: 'assistant', content: 'Halo! Aku asisten AI. Ada yang bisa kubantu?' }]
        input.value = ''
        render()
      })

      render()
    </script>
  </body>
  </html>
